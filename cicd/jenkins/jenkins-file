String urlRepo = "https://github.com/jnsierra/api-article.git"
String ipRegistry = "192.168.0.11"

pipeline {
    agent any
    parameters {
        choice(
            choices: ['greeting' , 'silence'],
            description: '',
            name: 'REQUESTED_ACTION')
    }

    stages {
        stage('Clone Repo'){
          steps {
            echo 'Ini Building...'
            echo 'Esta es la url del repo: ' + urlRepo
            sh 'mkdir -p build'
            dir('build'){
              git branch: 'develop', url: urlRepo
            }
            echo 'Compilando y construyendo el codigo desde maven'
            sh 'docker run --rm -v /root/.m2:/root/.m2 -v /volumenes/vol_jenkins/workspace/pipeline-job/build:/app -w /app maven:3-openjdk-11 mvn -B -DskipTests clean package'
            echo 'Fin Building...'
          }
        }
        stage('Copy jars'){
          steps{
            echo 'Iniciamos a copiar los artefactos generados'
            sh 'mkdir -p jars'
            sh 'mv build/api-acceso-datos/target/api-acceso-datos.jar server-acceso-datos/jar/'
            sh 'mv build/api-business/target/api-business.jar server-business/jar/'	
            sh 'mv build/api-server-config/target/api-server-config.jar server-config/jar/'
            sh 'mv build/api-service-discovery/target/api-service-discovery.jar server-discovery/jar/'
            sh 'mv build/api-gateway/target/api-gateway.jar server-gateway/jar/'
            echo 'Finalizamos la copia de los artefactos generados'
          }
        }
        stage('Test') {
              steps {
                echo 'Start Testing...'
                sh 'docker run --rm -v /root/.m2:/root/.m2 -v /volumenes/vol_jenkins/workspace/pipeline-job/build:/app -w /app maven:3-openjdk-11 mvn -B test'
                echo 'Finish Testing...'
              }
        }
        /**
        stage('Remove images...'){
            steps{
                sh 'docker rmi '+ipRegistry+':5000/server-gateway '+ipRegistry+':5000/server-discovery '+ipRegistry+':5000/server-config '+ipRegistry+':5000/server-business '+ipRegistry+':5000/server-acceso-datos '+ipRegistry+':5000/server-zipkin'
            }
        }*/
        stage('Tag Images'){
            steps {
                echo 'Ini Tag images...'
                dir('server-acceso-datos'){
                    sh 'docker build -t "'+ipRegistry+':5000/server-acceso-datos:latest" .'
                }   
                dir('server-business'){
                    sh 'docker build -t "'+ipRegistry+':5000/server-business:latest" .'
                } 
                dir('server-config'){
                    sh 'docker build -t "'+ipRegistry+':5000/server-config:latest" .'
                }
                dir('server-discovery'){
                    sh 'docker build -t "'+ipRegistry+':5000/server-discovery:latest" .'
                }
                dir('server-gateway'){
                    sh 'docker build -t "'+ipRegistry+':5000/server-gateway:latest" .'
                }
                dir('server-zipkin'){
                    sh 'docker build -t "'+ipRegistry+':5000/server-zipkin:latest" .'
                }
                echo 'Fin Tag images...'
            }
        }
        stage('Push Images'){
            steps {
                echo 'Ini up images registry'
                sh 'docker push '+ipRegistry+':5000/server-config:latest'
                sh 'docker push '+ipRegistry+':5000/server-business:latest'
                sh 'docker push '+ipRegistry+':5000/server-discovery:latest'
                sh 'docker push '+ipRegistry+':5000/server-gateway:latest'
                sh 'docker push '+ipRegistry+':5000/server-acceso-datos:latest'
                sh 'docker push '+ipRegistry+':5000/server-zipkin:latest'                
                echo 'Fin up images registry'
            }
        }
   }
}
